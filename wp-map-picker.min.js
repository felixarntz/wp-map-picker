/*!
 * WP Map Picker -  version 0.1.0
 * 
 * Felix Arntz <felix-arntz@leaves-and-love.net>
 */
!function(a,b){if("undefined"==typeof b||"undefined"==typeof b.maps)return a.fn.wpMapPicker=function(){return this},void console.error("Google Maps not found");var c='<div class="wp-mappicker-container" />',d='<div class="wp-mappicker-map-canvas-wrap" />',e='<div class="wp-mappicker-map-canvas" />',f={options:{store:"address",zoom:15,draggable:!0,mapType:"roadmap",default_location:{lat:"0.0",lng:"0.0",zoom:2},decimal_separator:".",change:!1},_create:function(){var f=this;a.extend(f.options,f.element.data()),f.default_latlng=f._parseLatLng(f.options.default_location),f.is_default=!0,f.element.wrap(c),f.canvas_wrap=a(d).insertAfter(f.element),f.canvas=a(e).appendTo(f.canvas_wrap),f.geocoder=new b.maps.Geocoder,f.map=new b.maps.Map(f.canvas[0],{center:f.default_latlng,zoom:f.options.default_location.zoom,draggable:f.options.draggable,tilt:0,streetViewControl:0,mapTypeId:b.maps.MapTypeId[f.options.mapType.toUpperCase()]}),this.marker=new b.maps.Marker({position:f.default_latlng,map:f.map,draggable:!0}),f._updateMap(),f._addListeners()},_addListeners:function(){var c=this;"coords"===c.options.store?c.element.on("change",function(){var a=c._parseLatLng(c.element.val());a&&c._createMap(a)}):c.element.autocomplete({source:function(b,d){c.geocoder.geocode({address:b.term},function(b){d(a.map(b,function(a){return{label:a.formatted_address,value:a.formatted_address,latlng:a.geometry.location}}))})},select:function(a,b){c.element.val(b.item.label),c._createMap(b.item.latlng),"function"==typeof c.options.change&&c.options.change.call(c)}}),b.maps.event.addListener(c.map,"click",function(a){c._updateFieldValue(a.latLng),c._createMap(a.latLng)}),b.maps.event.addListener(c.marker,"dragend",function(a){c._updateFieldValue(a.latLng),c._createMap(a.latLng)})},_updateFieldValue:function(a,b){var c=this;"coords"===c.options.store?(c.element.val(c._formatLatLng(a)),b||"function"!=typeof c.options.change||c.options.change.call(c)):c.geocoder.geocode({location:a},function(a){"undefined"!=typeof a[0]&&"undefined"!=typeof a[0].formatted_address&&(c.element.val(a[0].formatted_address),b||"function"!=typeof c.options.change||c.options.change.call(c))})},_createMap:function(a){var b=this;b.latlng=a,b.marker.setPosition(a),b.map.setCenter(a),b.is_default&&(b.is_default=!1,b.map.setZoom(b.options.zoom))},_resetMap:function(){var a=this;a.latlng=null,a.marker.setPosition(a.default_latlng),a.map.setCenter(a.default_latlng),a.map.setZoom(a.options.default_location.zoom),a.is_default=!0},_updateMap:function(){var a=this,b=a.element.val();if(b)if("coords"===a.options.store){var c=a._parseLatLng(b);c?a._createMap(c):(a.element.val(null),a._resetMap())}else a.geocoder.geocode({address:b},function(b){"undefined"!=typeof b[0]&&"undefined"!=typeof b[0].geometry&&"undefined"!=typeof b[0].geometry.location?a._createMap(b[0].geometry.location):(a.element.val(null),a._resetMap())});else a.element.val(null),a._resetMap()},_parseLatLng:function(a){var c=this;if("object"==typeof a&&"function"!=typeof a.lat)a=""+a.lat+"|"+a.lng;else if("object"==typeof a)return a;if("string"!=typeof a)return!1;if(a=a.split("|"),2!==a.length)return!1;for(var d=0;2>d;d++)a[d]=parseFloat(a[d].replace(c.options.decimal_separator,"."));return new b.maps.LatLng(a[0],a[1])},_formatLatLng:function(a){var b=this;return"string"==typeof a?a:(""+a.lat()).replace(".",b.options.decimal_separator)+"|"+(""+a.lng()).replace(".",b.options.decimal_separator)},clear:function(){this.element.val(null),this.is_default||(this._resetMap(),"function"==typeof this.options.clear&&this.options.clear.call(this))},refresh:function(){b.maps.event.trigger(this.map,"resize"),this.latlng?this.map.setCenter(this.latlng):this.map.setCenter(this.default_latlng)},latlng:function(a){return"undefined"==typeof a?this.latlng:void(a?(this._updateFieldValue(a,!0),this._createMap(a)):(this.element.val(null),this._resetMap()))},value:function(a){return"undefined"==typeof a?this.latlng?this.element.val():"":(this.element.val(a),void this._updateMap())}};a.widget("wp.wpMapPicker",f)}(jQuery,google);