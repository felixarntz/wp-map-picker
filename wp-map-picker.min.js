/*!
 * WP Map Picker -  version 0.7.1
 * 
 * Felix Arntz <felix-arntz@leaves-and-love.net>
 */
!function(a,b){if(void 0===b||void 0===b.maps)return a.fn.wpMapPicker=function(){return this},void console.error("Google Maps API not found");var c='<div class="wp-mappicker-container" />',d='<div class="wp-mappicker-map-canvas-wrap" />',e='<div class="wp-mappicker-map-canvas" />',f='<input style="width:300px;" type="text" id="pac-input" placeholder="Search address">',g={options:{store:"address",storeAdditional:!1,zoom:15,draggable:!0,mapType:"roadmap",defaultLocation:{lat:"0.0",lng:"0.0",zoom:2},decimalSeparator:".",change:!1,clear:!1},_create:function(){var g=this;a.extend(g.options,g.element.data()),g.defaultLatLng=g._parseLatLng(g.options.defaultLocation),g.is_default=!0,g.element.wrap(c),g.canvas_wrap=a(d).insertAfter(g.element),g.input=a(f).insertBefore(g.canvas_wrap),g.canvas=a(e).appendTo(g.canvas_wrap),g.geocoder=new b.maps.Geocoder,g.map=new b.maps.Map(g.canvas[0],{center:g.defaultLatLng,zoom:g.options.defaultLocation.zoom,draggable:g.options.draggable,tilt:0,streetViewControl:0,mapTypeId:b.maps.MapTypeId[g.options.mapType.toUpperCase()]}),g.marker=new b.maps.Marker({position:g.defaultLatLng,map:g.map,draggable:!0}),g.input.on("keydown",function(a){if(13===a.keyCode)return a.preventDefault(),!1});var h=new b.maps.places.SearchBox(g.input.get(0));g.map.controls[b.maps.ControlPosition.TOP_LEFT].push(g.input.get(0)),g.map.addListener("bounds_changed",function(){h.setBounds(g.map.getBounds())});var i=[];h.addListener("places_changed",function(){var a=h.getPlaces();if(0!==a.length){i.forEach(function(a){a.setMap(null)}),i=[];var c=new b.maps.LatLngBounds;a.forEach(function(a){if(!a.geometry)return void console.log("Returned place contains no geometry");var d={url:a.icon,size:new b.maps.Size(20,20),origin:new b.maps.Point(0,0),anchor:new b.maps.Point(17,34),scaledSize:new b.maps.Size(25,25)};i.push(new b.maps.Marker({map:g.map,icon:d,title:a.name,position:a.geometry.location})),a.geometry.viewport?c.union(a.geometry.viewport):c.extend(a.geometry.location)}),g.map.fitBounds(c)}});var j=g.element.val();"coords"===g.options.store?g._geocodeLatLng(j,g._initMap):g._geocodeAddress(j,g._initMap),"coords"===g.options.store?g.element.on("change",function(){g._geocodeLatLng(g.element.val(),g._updateMap)}):g.element.autocomplete({source:function(a,b){g._geocodeAddress(a.term,function(a){b(a?[{label:a.formatted_address,value:a.formatted_address,latlng:a.geometry.location,geocoded:a}]:[])})},select:function(a,b){g._updateMap(b.item.geocoded)}}),g.map.addListener("click",function(a){var c=a.latLng.lat(),d=a.latLng.lng();g.marker.setPosition(new b.maps.LatLng(c,d))}),b.maps.event.addListener(g.map,"click",function(a){g._geocodeLatLng(a.latLng,g._updateField)}),b.maps.event.addListener(g.marker,"dragend",function(a){g._geocodeLatLng(a.latLng,g._updateField)})},_initMap:function(a){a?(this.latlng=a.geometry.location,this.marker.setPosition(this.latlng),this.map.setCenter(this.latlng),this.is_default&&(this.is_default=!1,this.map.setZoom(this.options.zoom))):(this.latlng=null,this.marker.setPosition(this.defaultLatLng),this.map.setCenter(this.defaultLatLng),this.is_default||(this.is_default=!0,this.map.setZoom(this.options.defaultLocation.zoom)))},_updateMap:function(b){this._initMap(b),this.options.storeAdditional&&this._updateAdditionalFields(b),"function"==typeof this.options.change&&this.options.change.call(this),a(document).trigger("wpMapPicker.updateMap",[b,this])},_updateField:function(b){b?(this.latlng=b.geometry.location,"coords"===this.options.store?this.element.val(this._formatLatLng(b.geometry.location)):this.element.val(b.formatted_address)):(this.latlng=null,this.element.val(null)),this.options.storeAdditional&&this._updateAdditionalFields(b),"function"==typeof this.options.change&&this.options.change.call(this),a(document).trigger("wpMapPicker.updateField",[b,this])},_updateAdditionalFields:function(b){var c,d,e,f,g=Object.keys(this.options.storeAdditional);for(var h in g){if(d=g[h],c=this.options.storeAdditional[d],f=a(d).val(),e=null,b)switch(c){case"coords":e=this._formatLatLng(b.geometry.location);break;case"address":e=b.formatted_address;break;case"latitude":e=this._formatLatOrLng(b.geometry.location.lat());break;case"longitude":e=this._formatLatOrLng(b.geometry.location.lng());break;default:void 0!==b[c]&&(e=b[c])}e!==f&&a(d).val(e).trigger("change")}},_geocodeLatLng:function(a,b){if(!a)return void b.apply(this,[a]);this._geocodeObject({location:this._parseLatLng(a)},b)},_geocodeAddress:function(a,b){if(!a)return void b.apply(this,[a]);this._geocodeObject({address:a},b)},_geocodeObject:function(a,b){var c=this;c.geocoder.geocode(a,function(a){var d;null!==a&&void 0!==a[0]&&(d=a[0]),b.apply(c,[d])})},_parseLatLng:function(a){if("object"==typeof a&&"function"!=typeof a.lat)a=a.lat+"|"+a.lng;else if("object"==typeof a)return a;if("string"!=typeof a)return!1;if(a=a.split("|"),2!==a.length)return!1;for(var c=0;c<2;c++)a[c]=this._parseLatOrLng(a[c]);return new b.maps.LatLng(a[0],a[1])},_parseLatOrLng:function(a){return parseFloat(a.replace(this.options.decimalSeparator,"."))},_formatLatLng:function(a){return"string"==typeof a?a:this._formatLatOrLng(a.lat())+"|"+this._formatLatOrLng(a.lng())},_formatLatOrLng:function(a){return(""+a).replace(".",this.options.decimalSeparator)},clear:function(){this._initMap(),this._updateField(),"function"==typeof this.options.clear&&this.options.clear.call(this)},refresh:function(){b.maps.event.trigger(this.map,"resize"),this.latlng?this.map.setCenter(this.latlng):this.map.setCenter(this.defaultLatLng)}};a.widget("wp.wpMapPicker",g)}(jQuery,window.google);